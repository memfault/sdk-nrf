/*
 * Copyright (c) 2023 Nordic Semiconductor ASA
 *
 * SPDX-License-Identifier: LicenseRef-Nordic-5-Clause
 */

#include <zephyr/kernel.h>
#include <stdio.h>
#include <zephyr/drivers/sensor.h>
#include <app_event_manager.h>
#include <math.h>

#if defined(CONFIG_EXTERNAL_SENSORS)
#include "ext_sensors.h"
#endif

#if defined(CONFIG_ADP536X)
#include <adp536x.h>
#endif

#define MODULE sensor_module

#include "modules_common.h"
#include "events/app_module_event.h"
#include "events/data_module_event.h"
#include "events/sensor_module_event.h"
#include "events/util_module_event.h"

#include <zephyr/logging/log.h>
LOG_MODULE_REGISTER(sensor_module, CONFIG_SENSOR_MODULE_LOG_LEVEL);


#if defined(CONFIG_NPM1300_CHARGER)
#include <zephyr/drivers/sensor/npm1300_charger.h>
#include "nrf_fuel_gauge.h"
static const struct device *charger = DEVICE_DT_GET(DT_NODELABEL(npm1300_charger));
static const struct battery_model battery_model = {
	.param_1 = {0.0, 0.005, 0.01, 0.015, 0.02, 0.025, 0.03, 0.035, 0.04, 0.045, 0.05, 0.055, 0.06, 0.065, 0.07, 0.075, 0.08, 0.085, 0.09, 0.095, 0.1, 0.105, 0.11, 0.115, 0.12, 0.125, 0.13, 0.135, 0.14, 0.145, 0.15, 0.155, 0.16, 0.165, 0.17, 0.17500000000000002, 0.18, 0.185, 0.19, 0.195, 0.2, 0.20500000000000002, 0.21, 0.215, 0.22, 0.225, 0.23, 0.23500000000000001, 0.24, 0.245, 0.25, 0.255, 0.26, 0.265, 0.27, 0.275, 0.28, 0.28500000000000003, 0.29, 0.295, 0.3, 0.305, 0.31, 0.315, 0.32, 0.325, 0.33, 0.335, 0.34, 0.34500000000000003, 0.35000000000000003, 0.355, 0.36, 0.365, 0.37, 0.375, 0.38, 0.385, 0.39, 0.395, 0.4, 0.405, 0.41000000000000003, 0.41500000000000004, 0.42, 0.425, 0.43, 0.435, 0.44, 0.445, 0.45, 0.455, 0.46, 0.465, 0.47000000000000003, 0.47500000000000003, 0.48, 0.485, 0.49, 0.495, 0.5, 0.505, 0.51, 0.515, 0.52, 0.525, 0.53, 0.535, 0.54, 0.545, 0.55, 0.555, 0.56, 0.5650000000000001, 0.5700000000000001, 0.5750000000000001, 0.58, 0.585, 0.59, 0.595, 0.6, 0.605, 0.61, 0.615, 0.62, 0.625, 0.63, 0.635, 0.64, 0.645, 0.65, 0.655, 0.66, 0.665, 0.67, 0.675, 0.68, 0.685, 0.6900000000000001, 0.6950000000000001, 0.7000000000000001, 0.705, 0.71, 0.715, 0.72, 0.725, 0.73, 0.735, 0.74, 0.745, 0.75, 0.755, 0.76, 0.765, 0.77, 0.775, 0.78, 0.785, 0.79, 0.795, 0.8, 0.805, 0.81, 0.8150000000000001, 0.8200000000000001, 0.8250000000000001, 0.8300000000000001, 0.835, 0.84, 0.845, 0.85, 0.855, 0.86, 0.865, 0.87, 0.875, 0.88, 0.885, 0.89, 0.895, 0.9, 0.905, 0.91, 0.915, 0.92, 0.925, 0.93, 0.935, 0.9400000000000001, 0.9450000000000001, 0.9500000000000001, 0.9550000000000001, 0.96, 0.965, 0.97, 0.975, 0.98, 0.985, 0.99, 0.995, 1.0},
	.temps = {5, 25, 45},
	.param_2 = {2.99, 3.0, 3.01, 3.0199999999999996, 3.0299999999999994, 3.039999999999999, 3.049999999999999, 3.0599999999999987, 3.0699999999999985, 3.0799999999999983, 3.089999999999998, 3.099999999999998, 3.1099999999999977, 3.1199999999999974, 3.1299999999999972, 3.139999999999997, 3.149999999999997, 3.1599999999999966, 3.1699999999999964, 3.179999999999996, 3.189999999999996, 3.1999999999999957, 3.2099999999999955, 3.2199999999999953, 3.229999999999995, 3.239999999999995, 3.2499999999999947, 3.2599999999999945, 3.2699999999999942, 3.279999999999994, 3.289999999999994, 3.2999999999999936, 3.3099999999999934, 3.319999999999993, 3.329999999999993, 3.3399999999999928, 3.3499999999999925, 3.3599999999999923, 3.369999999999992, 3.379999999999992, 3.3899999999999917, 3.3999999999999915, 3.4099999999999913, 3.419999999999991, 3.429999999999991, 3.4399999999999906, 3.4499999999999904, 3.45999999999999, 3.46999999999999, 3.4799999999999898, 3.4899999999999896, 3.4999999999999893, 3.509999999999989, 3.519999999999989, 3.5299999999999887, 3.5399999999999885, 3.5499999999999883, 3.559999999999988, 3.569999999999988, 3.5799999999999876, 3.5899999999999874, 3.599999999999987, 3.609999999999987, 3.619999999999987, 3.6299999999999866, 3.6399999999999864, 3.649999999999986, 3.659999999999986, 3.6699999999999857, 3.6799999999999855, 3.6899999999999853, 3.699999999999985, 3.709999999999985, 3.7199999999999847, 3.7299999999999844, 3.7399999999999842, 3.749999999999984, 3.759999999999984, 3.7699999999999836, 3.7799999999999834, 3.789999999999983, 3.799999999999983, 3.8099999999999827, 3.8199999999999825, 3.8299999999999823, 3.839999999999982, 3.849999999999982, 3.8599999999999817, 3.8699999999999815, 3.8799999999999812, 3.889999999999981, 3.899999999999981, 3.9099999999999806, 3.9199999999999804, 3.92999999999998, 3.93999999999998, 3.9499999999999797, 3.9599999999999795, 3.9699999999999793, 3.979999999999979, 3.989999999999979, 3.9999999999999787, 4.0099999999999785, 4.019999999999978, 4.029999999999978, 4.039999999999978, 4.049999999999978, 4.059999999999977, 4.069999999999977, 4.079999999999977, 4.089999999999977, 4.0999999999999766, 4.109999999999976, 4.119999999999976, 4.129999999999976, 4.139999999999976, 4.1499999999999755, 4.159999999999975, 4.169999999999975, 4.179999999999975, 4.189999999999975, 4.199999999999974},
	.param_3 = {-0.00840474201087503, -0.007132390626084405, -0.00606129805892047, -0.0051532864230195395, -0.004370274374946719, -0.0036808656418787326, -0.0030664961387782256, -0.00251656654855884, -0.0020262830623165276, -0.0015938889960753482, -0.001220984373888879, -0.0009183847137507032, -0.0007150055136142145, -0.000611923763426682, -0.0005788926783216044, -0.0005795383255295765, -0.0005934169617668937, -0.0006108383256998075, -0.0006292024237456392, -0.000648023509894969, -0.0006677913712389802, -0.0006886268290292, -0.0007095187288132374, -0.0007286883986312875, -0.000741243490756811, -0.0007400234460227521, -0.0007218667753203951, -0.0006907495006349127, -0.000653772921152314, -0.0006162296186985787, -0.0005795366205313821, -0.0005432651501386099, -0.0005072280725592678, -0.00046943958630950864, -0.00042432241226547526, -0.0003831567180465359, -0.00035348849298537903, -0.00033079736967542734, -0.0003101084478952422, -0.0002910881242797721, -0.00027546152418289523, -0.00026344451792795914, -0.00025332652725032376, -0.000241702050187132, -0.00022662784433245174, -0.00021126127473052232, -0.0001948471246093232, -0.00017517203228173062, -0.0001510038359830198, -0.0001224065975488763, -8.970649742587275e-05, -5.381671190863358e-05, -1.5811044083976546e-05, 2.3535644733060208e-05, 6.382200686538983e-05, 0.00010486440849194264, 0.00014744052388367986, 0.0001927243704353949, 0.00024301048326341645, 0.0003022608885732895, 0.0003733162192400539, 0.0004503776625258097, 0.000524016267050269, 0.0005879881716222781, 0.0006414318645824436, 0.000684341835428977, 0.0007193333941945084, 0.0007502492970829055, 0.0007798590192558517, 0.0008089115143073006, 0.000837925247713917, 0.0008673423439002803, 0.0008975643316678546, 0.0009288979663499908, 0.000961453367168472, 0.0009953109648191266, 0.0010305177264447432, 0.001067119420949191, 0.001105142749948924, 0.0011444997995671297, 0.0011850450459574475, 0.0012266096742333213, 0.0012691138547030174, 0.0013124525913638348, 0.0013563017197098367, 0.0014001865292847593, 0.0014435659852839776, 0.00148598684946129, 0.0015270453644131246, 0.001566210781523436, 0.0016028038016609738, 0.0016363104237321782, 0.0016664000889375157, 0.0016927876144579878, 0.0017151911514258836, 0.0017332926622925689, 0.0017467237254065512, 0.0017551987453313423, 0.0017588440140737585, 0.001757833311118325, 0.0017511236344276797, 0.0017361798557261891, 0.0017109828762314433, 0.0016768092969800745, 0.0016366170583870451, 0.0015926850099465164, 0.0015464643102519797, 0.0015006928866567162, 0.0014569006788923346, 0.0014106974985526966, 0.0013561966330459297, 0.001292214766294963, 0.001222766110904192, 0.0011521451288583893, 0.0010846462821425163, 0.0010245137527042998, 0.0009742653662808107, 0.000934316059137998, 0.0009049550918870265, 0.0008864717251389577, 0.0008791141973137556, 0.0008813684315397821, 0.0008891862444026292, 0.0008982925623225936, 0.0009044123116367185, 0.000903330091920387, 0.000893671227492863, 0.0008777193959331651, 0.0008577813865659656, 0.0008361588066999867, 0.000815134005402254, 0.0007958961211408336, 0.0007780549735359309, 0.0007612132165608588, 0.0007449852429526725, 0.0007289869338732788, 0.0007129351887884943, 0.0006967590729746919, 0.0006806014484046275, 0.0006646561791963753, 0.000649116459704963, 0.0006341203398875139, 0.0006197047887454993, 0.0006058294314373309, 0.0005924092080886595, 0.0005793584392850296, 0.0005666084449835058, 0.0005541223454325884, 0.0005418909705270112, 0.0005299434924756338, 0.0005183124185562885, 0.000507024963238536, 0.0004960978756550072, 0.0004855337693652141, 0.0004752826853565018, 0.000465281297883066, 0.0004554691453730361, 0.00044579182226088456, 0.0004362017573444146, 0.0004267232381105695, 0.0004174275861326223, 0.00040839133150349076, 0.0003997009478970788, 0.00039144238238608974, 0.00038358461403495967, 0.0003759133671264924, 0.0003681978745056687, 0.00036020616438015886, 0.0003517060861071265, 0.0003425154461566441, 0.00033265406482263455, 0.0003221843507053346, 0.0003111467051766444, 0.0002995780043466804, 0.0002875167442940218, 0.0002750204654873356, 0.0002621653527407685, 0.0002490452690412949, 0.00023575709760296636, 0.00022239658657592483, 0.00020899027010747275, 0.00019545488700788879, 0.00018169220996306645, 0.00016760296703276245, 0.0001530878862765446, 0.00013803439229096207, 0.0001222831825992894, 0.00010568335676675044, 8.808839981518464e-05, 6.935179676629401e-05, 4.9297885338575766e-05, 2.7468545614622888e-05, 3.3858220239033803e-06, -2.3388637224641675e-05, -5.329318392219141e-05, -8.676616985966735e-05, -0.0001242459468282658, -0.0001661708666190285, -0.0002129792810230487, -0.000265109541831351, -0.0003230000008350287},
	.param_4 = {3.4195659378806442, 3.4259892227217392, 3.431440325147376, 3.436205536020441, 3.4405619266490466, 3.4445616304389652, 3.448140019120138, 3.451452128051462, 3.454629593097261, 3.45759253812322, 3.460075926912497, 3.4621406763934, 3.464735457447791, 3.4683495991870186, 3.472798351844984, 3.477502784987308, 3.481999820626328, 3.486213625255407, 3.490255519608574, 3.4941009602075543, 3.4978173773573853, 3.5015936629647353, 3.505515037534469, 3.50960738894937, 3.5138199523543947, 3.517944644110352, 3.521787486732728, 3.5253525951844793, 3.5286816650536283, 3.5317755158868613, 3.5346716525683206, 3.537438403156173, 3.540146446122409, 3.5428074578068625, 3.5452263301887013, 3.5477811113864104, 3.5506920149127716, 3.553752081785055, 3.55674689706576, 3.5596410926630684, 3.5624778729628606, 3.5652783428256773, 3.5680199746354004, 3.5706607199547484, 3.5731881946300343, 3.5756641652558225, 3.578098799494524, 3.5804710450110813, 3.5827643492281083, 3.584976828022486, 3.587109437904138, 3.5891684470660072, 3.591163271606459, 3.5931055382119514, 3.5950036708982704, 3.5968636554082787, 3.5986806351180807, 3.6004410237630875, 3.602106350998852, 3.6036170629956015, 3.604933723181361, 3.60612324632219, 3.607298216149558, 3.608541705184014, 3.609874474787084, 3.6113025432369272, 3.612797952473416, 3.6143213432494155, 3.6158537977946548, 3.6174003255945872, 3.6189544210379143, 3.620501237748654, 3.6220350504760708, 3.6235721726571555, 3.6251320437333003, 3.6267112642300465, 3.6282922395387764, 3.6298683901126476, 3.6314602669015086, 3.633091387487945, 3.634745073645084, 3.63638017948311, 3.6379811755227527, 3.6395952754955014, 3.6412760091800975, 3.643022561764787, 3.6448031256187665, 3.6465987552793946, 3.6484227462548025, 3.6502933297021096, 3.652220528116212, 3.6542064318343193, 3.656258028961107, 3.6583951207771923, 3.6606364005338374, 3.6629813004227594, 3.665420741261817, 3.667947756511627, 3.670549707379963, 3.6732128739323895, 3.675975189802615, 3.67894468106267, 3.6822164886248676, 3.685750363599464, 3.689426963351892, 3.6931567847436906, 3.6969345157121873, 3.7007694015404526, 3.7047014496137183, 3.708832372722377, 3.7132241479203674, 3.717845490707805, 3.722622806072806, 3.7275221912009697, 3.7325131228613118, 3.7375655938165413, 3.742664557808768, 3.7477893874489236, 3.7528902752345155, 3.7579153638579226, 3.7628132746037486, 3.767555344739084, 3.7721636598457926, 3.776681659580988, 3.781153781361226, 3.7856237664152808, 3.790103204466711, 3.7945732645803734, 3.799023219731317, 3.80344257415933, 3.807821056783683, 3.8121610893257274, 3.8164806910398954, 3.820793834395825, 3.825114015388709, 3.8294547126487855, 3.833828125809854, 3.838240730044218, 3.8426894247577885, 3.84716908956437, 3.851674611890843, 3.856201541158433, 3.860747069442914, 3.8653113589614994, 3.869896292639652, 3.8745037816068146, 3.8791355640094323, 3.883793364717292, 3.8884782146490484, 3.893189681761921, 3.897927205076426, 3.902690261060596, 3.907478140924564, 3.912290434210533, 3.917128741624537, 3.9219951767187338, 3.9268918005531503, 3.9318203917942296, 3.936782355666626, 3.9417763408104345, 3.946799193410908, 3.951847723074588, 3.9569190732114343, 3.9620106987705954, 3.9671245413857474, 3.972269567415495, 3.9774554690436283, 3.982692881303659, 3.987992918806928, 3.9933647850663005, 3.9988099392553287, 4.004327527716237, 4.009913443387692, 4.015561985130212, 4.021267380567798, 4.0270231275047275, 4.032822710996989, 4.038663087407684, 4.044542728665881, 4.0504601556219795, 4.0564165422947145, 4.06241712868549, 4.068467006995834, 4.074571064076377, 4.080734186355094, 4.08696177028345, 4.093260932377959, 4.099637657502817, 4.106097401757448, 4.1126456208140665, 4.119288887813831, 4.126047559373961, 4.132955076535157, 4.140046672285913, 4.147357580242069, 4.154923034019454, 4.162778267233899, 4.170958513501241, 4.17949900643731, 4.188434979657938, 4.1978016667789575},
	.param_5 = {1.284656968219, 1.1874387266731734, 1.0216313298701873, 0.9121601501670629, 0.835609441852414, 0.7578092471091313, 0.6890497612496826, 0.6489573977122909, 0.614041007175814, 0.5446333815236404, 0.4548138270179969, 0.46595305352936656, 0.6208922793618399, 0.8062894397192988, 0.9153185800289343, 0.920146878134398, 0.8710840268098874, 0.8255698982245985, 0.7887334952147551, 0.7561857748811462, 0.7492702757180947, 0.769766017708351, 0.8013725984634679, 0.8304914819925902, 0.833725516098216, 0.7967534378333418, 0.7407951074127173, 0.6894178320900224, 0.642292070238204, 0.5989987514692263, 0.5662887269311856, 0.5474793554088198, 0.5369054650689264, 0.507988406629245, 0.4973653579547932, 0.5465684724070385, 0.5970970398644582, 0.6054882152988217, 0.5889010878013412, 0.5730975897100699, 0.5637250162608964, 0.5542101672539879, 0.5382377129071081, 0.5168219994633905, 0.5003445301074105, 0.4910604864489798, 0.48068797552587306, 0.4665549733584129, 0.4505783011404585, 0.43450886760298957, 0.41916190435213885, 0.40538337023208193, 0.3937091145944205, 0.3840399291811458, 0.37581171963272375, 0.36769642198102304, 0.35773683548088187, 0.34257158807711185, 0.3176039232513972, 0.2827372182509169, 0.25061833265884736, 0.2364492968196963, 0.24184588618241243, 0.25762586375259744, 0.27608380529131615, 0.29234776863322764, 0.3018800012488221, 0.3055845321238593, 0.3078982345171788, 0.3100623243259548, 0.3100912154066826, 0.3080629438156457, 0.30709349085014104, 0.30969932572295633, 0.31390915728910507, 0.3160195805476107, 0.3157125882601086, 0.316802736273214, 0.32229973752975205, 0.32848067435753414, 0.32887919951649636, 0.3236101877668762, 0.32150960123913386, 0.3294833657344842, 0.34272862692854567, 0.3527116438668987, 0.3576193514607695, 0.3619620636035936, 0.36945744227150357, 0.3797781861409444, 0.3913102132209634, 0.4037500844895181, 0.41886889428730534, 0.4378371572730355, 0.4586179645567068, 0.4784340727979508, 0.4966456088867588, 0.512896611814595, 0.5265117420762522, 0.5425482422652284, 0.573180713028032, 0.6241298822252439, 0.6805682536794144, 0.7210474727024518, 0.7406421144226627, 0.7507552360295211, 0.7612616796762062, 0.7766933901530937, 0.806297118192445, 0.852269830664909, 0.9013117985428032, 0.9398658152438788, 0.9676700493164603, 0.9890316788505604, 1.0043402615571573, 1.0151434947456295, 1.022379363238235, 1.0225717425747405, 1.0125976408998927, 0.9922999369233132, 0.9639980881161581, 0.9350385242044013, 0.9126314841903849, 0.8990121515433547, 0.8942106834292751, 0.8949423105484744, 0.8949498165092606, 0.8920015264606285, 0.8869309578956486, 0.8797837052366031, 0.8718515166397545, 0.865963425621219, 0.8632745070097592, 0.8633324348813698, 0.8660878252960469, 0.8714110421145005, 0.8786017395432388, 0.8861298947934415, 0.8928359520152362, 0.8985187133054406, 0.9032451594062962, 0.9072457552071089, 0.9109817803066189, 0.9149223196737832, 0.9192422645315279, 0.9239271369780422, 0.9289583110477562, 0.9342650639616146, 0.9396317044628955, 0.944899042737779, 0.9500579298674872, 0.9550935848137598, 0.9600173149936886, 0.9650600699973033, 0.9704742508200859, 0.976305892861351, 0.982521507549583, 0.9890555113475585, 0.995594901620489, 1.0016837744282192, 1.0071382264153605, 1.01198798005262, 1.0162975696007326, 1.0205468174313115, 1.0258868644899444, 1.0330927657880906, 1.0423313888164198, 1.0537449763299733, 1.0671903762641488, 1.0817020448400605, 1.0962742649936352, 1.1103504132363273, 1.1234457413975107, 1.1353937180105689, 1.1461142374515454, 1.1555330429191102, 1.1639959902956853, 1.1720017668892524, 1.1797068214295159, 1.1873813628833219, 1.195697306351029, 1.20504647011197, 1.215393539088705, 1.2267179359259472, 1.2390706207073166, 1.2526746022865076, 1.2675887219367077, 1.2836469379489124, 1.3007963311249426, 1.319148605638354, 1.3401938559894688, 1.3666188721325412, 1.3999112911951883, 1.4402503706912206, 1.487636173354101, 1.5420686991830301, 1.6035479481787185, 1.6720739203410773, 1.7476466156696624, 1.8302660341647403, 1.8733374242039247},
	.param_6 = {0.25447027695812485, 0.234344395195456, 0.1979104203064866, 0.16910236839737508, 0.1472420781140807, 0.13037782361684935, 0.11642990933198927, 0.10402130764616979, 0.09226775524834915, 0.08052986884276485, 0.06755042823246449, 0.050597886027466454, 0.030646095032402124, 0.013611283529261012, 0.003238543789710552, -0.0014524283445289292, -0.0031300000170230964, -0.00357854619787455, -0.003718518419516153, -0.0038588947493341046, -0.004060331913423103, -0.004172735757425718, -0.004006156960208748, -0.0031724761943573566, -0.0011335047391464572, 0.0019376715436415933, 0.0049273945387839375, 0.006809385416808107, 0.007451988193633396, 0.007423630062093189, 0.0072964468559968835, 0.007230854797211429, 0.0073825563829101265, 0.008290566029379255, 0.008628286826297273, 0.007083391928009624, 0.0052359348371108574, 0.004338004509013685, 0.003970924539565526, 0.003464692371234695, 0.0027643606351812934, 0.0022134996932571477, 0.002174246774082713, 0.0026698682917872013, 0.003044077545660969, 0.003178071972312853, 0.00360892424487917, 0.004384328862630342, 0.0052765434732854315, 0.006129733855714704, 0.006858988564024272, 0.00738954533418962, 0.007735235664169379, 0.007963305094936639, 0.008132876375888243, 0.008361851701829001, 0.008785996194345225, 0.00955699593797366, 0.01095365181378946, 0.013030573597663745, 0.014811677395252017, 0.015070004781021513, 0.013761050909646846, 0.011741559753217461, 0.00963536638066988, 0.007790152961206472, 0.006590746165392855, 0.006052562506134337, 0.005866221722439506, 0.005806622845806525, 0.005843082959297976, 0.005963908395393767, 0.006155562244971051, 0.006388903550061734, 0.006641299846913578, 0.006906435927627125, 0.00718084561300643, 0.0074625023504180845, 0.007738037861793881, 0.007990229600852343, 0.00821098746661916, 0.008406880874556995, 0.00858429171305135, 0.00871878650068193, 0.008773393792092452, 0.00872642655741409, 0.008580032017653071, 0.008347937912914693, 0.008022393206214593, 0.007575843724784924, 0.007009964220874225, 0.006359628727654193, 0.0056477190725809584, 0.004879106248836785, 0.004050504783458106, 0.0031532573980667597, 0.002190608303877348, 0.0012120288667207338, 0.00026345657869826424, -0.0007720379646078803, -0.0021653455392135843, -0.00401407581962364, -0.005937055874611469, -0.007436581784439817, -0.008412428703355804, -0.009015274813506544, -0.009199212328980019, -0.008956363135964509, -0.008999538810401967, -0.010070404584640487, -0.011848273225773366, -0.013343052214173775, -0.014006963743657362, -0.013811982876167573, -0.012763137615408943, -0.011038091586170556, -0.00901976935663018, -0.006931027439378422, -0.004784433399904035, -0.0025840894573270884, -0.0005103293599175579, 0.0010072047088873675, 0.001692413078281153, 0.0015226067234089301, 0.0005037529597793407, -0.0010741084143855496, -0.0025610695987221977, -0.0035889840926897447, -0.004156058923317836, -0.004264738116371163, -0.004026268555915306, -0.003707903186632303, -0.00346829045799748, -0.0033069730583258432, -0.003222628268758005, -0.003205005416417818, -0.0032227860898586917, -0.0032333740383866795, -0.0032102893778316547, -0.0031484988699664483, -0.003053583930886139, -0.002941167095946379, -0.002829090845018307, -0.0027295580656839765, -0.0026470992152301297, -0.0025800763105153697, -0.0025236093852441105, -0.0024717474456494547, -0.0024178852956954658, -0.002357855197072272, -0.002291852923709775, -0.002221454290128133, -0.0021491193873321964, -0.00208151902985054, -0.0020252471482148093, -0.0019813539983465694, -0.0019489475622181426, -0.00192673880286215, -0.0019068584150315048, -0.0018774171211792296, -0.0018331906607078755, -0.001772663823554349, -0.001694894911740102, -0.001611633386211915, -0.0015529015259597317, -0.0015386739529290986, -0.001570720274633356, -0.0016491788398542186, -0.0017690718223514735, -0.0019052021284491944, -0.0020331095451309516, -0.002150735964599016, -0.0022606346358654207, -0.0023629960882622604, -0.0024557538859344818, -0.0025351391553253316, -0.0025975196446040663, -0.0026408255137802114, -0.0026648682465370095, -0.00267668274954936, -0.002694169956803604, -0.002729806014440631, -0.002785191997512634, -0.002860432368652184, -0.0029568574741800375, -0.0030804703677255216, -0.0032351035524211622, -0.0034194782784104753, -0.0036331560000456434, -0.003879051447660887, -0.004188325115167112, -0.004591206331467239, -0.0050857182839264565, -0.005667900594609479, -0.006337753263502568, -0.0070952762906074385, -0.007940469675936115, -0.008873333419478293, -0.009893867521232252, -0.011002071981198, -0.011578091800735536},
	.param_7 = {0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 1.5474101365173875e-05, 3.752005282832004e-05, 5.95660042914662e-05, 8.161195575461236e-05, 0.00010365790721775852, 0.00012583795052922156, 0.0001520838677806686, 0.00017832978503211564, 0.0002045757022835626, 0.0002308216195350096, 0.0002583448194655784, 0.000289334037886278, 0.0003203232563069777, 0.0003513124747276774, 0.0003834571037770925, 0.0004193500166712886, 0.00045524292956548466, 0.0004911358424596805, 0.0005305776751520069, 0.000571183386231507, 0.0006117890973110071, 0.0006555390622651541, 0.0007008053156844483, 0.0007460715691037422, 0.0007957577832939303, 0.0008458640367941943, 0.0008982198213244015, 0.0009537010873047195, 0.0010102112777312703, 0.00107190947188926, 0.0011346624793432476, 0.001203921384520886, 0.001276887041241627, 0.0013393649168546467, 0.0011978342874760847, 0.0009753506215551368, 0.0007407254966876979, 0.0006404834590642292, 0.0007393745640687916, 0.0009108624434917654, 0.0009653319439879497, 0.0009082399447200401, 0.0008516312548447071, 0.0008195094792550703, 0.0007492660591072847, 0.0006066917030186697, 0.0004651828761382754, 0.0004340096426349879, 0.0003870634423194712, 0.0002562239734740291, 5.721933075860642e-06, -0.0003301036005529778, -0.0007349857593371545, -0.0012169873776007201, -0.0016950667247476697, -0.0020622935358062633, -0.0022836136637410403, -0.0024389864175471594, -0.0025588037152918983, -0.0026558600109961375, -0.002693149818559986, -0.002705652117884718, -0.002708150726510912, -0.002672510402536133, -0.0025891604157656507, -0.0024505811783953036, -0.002229153084306528, -0.0018479552410988326, -0.0013865133164710926, -0.00100722085058271, -0.000938560225486116, -0.0009581021262271683, -0.0010074647496973446, -0.0010427842152852934, -0.0010182576008143389, -0.0009449596901230736, -0.0008737052254147128, -0.0008088830327836185, -0.0007489728657313162, -0.0006952629726073302, -0.000647729656169396, -0.0006047584973701334, -0.0005660410039703667, -0.0005308732128737585, -0.0004987590900557618, -0.000468872521658061, -0.0004412340672839016, -0.0004162056147681239, -0.0003934127439016148, -0.0003713302318414216, -0.0003484190740570156, -0.0003241472605207855, -0.000299269381723656, -0.0002742159681783475, -0.00024926338269578815, -0.00022458161872772553, -0.0002004327026429227, -0.0001770278933869402, -0.0001539002266713195, -0.00013041860015562256, -0.00010649556051955359, -8.142085499528368e-05, -5.506255371930414e-05, -2.7089546431016938e-05, 3.5964289661260273e-06, 3.684070775409561e-05, 7.143446704485195e-05, 0.00010878237733367664, 0.00014687199068108933, 0.0001587427868919642, 1.967819491594569e-05, -4.2931724355351234e-18},
	.param_8 = {0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, -0.00018053118259369542, -0.0004377339496637343, -0.0006949367167337731, -0.000952139483803812, -0.0010876899961341528, -0.0010271158268019176, -0.0010139768534361618, -0.0010008378800704064, -0.0009876989067046501, -0.0009653194999841757, -0.0009099972014755485, -0.0008951117853517828, -0.0008802263692280159, -0.0008653409531042489, -0.0008186561502629966, -0.0007993147135511326, -0.000779973276839269, -0.000760631840127405, -0.000726941207734598, -0.0007026257239372964, -0.0006783102401399972, -0.0006539960240049326, -0.0006211885649603502, -0.0005883811059157635, -0.0005604820746811979, -0.0005079227065705461, -0.0004816078671425527, -0.0004133915240136971, -0.00035688588768429167, -0.0003052170496638786, -0.00023815667765256392, -0.0001759958113503199, -0.00010616285775500087, 0.00075503859295298, 0.010147947564382408, 0.023982725333889517, 0.04089005958893273, 0.0564384189211875, 0.06790516292791103, 0.07783146450846148, 0.08863101788515637, 0.10138475656261951, 0.11445927126199433, 0.12774857856729524, 0.1425693392118514, 0.1603403939163056, 0.17934478001417986, 0.1960130454907587, 0.21417483976691457, 0.23478745999619668, 0.25898151510456635, 0.28634385543574287, 0.3160233218981749, 0.3473111496867079, 0.3788991019908625, 0.40890784779428785, 0.43596867842001513, 0.4604322818288809, 0.4823487453526736, 0.5025115117485299, 0.5193412970177083, 0.5348456206473841, 0.5498572360605312, 0.5634439118595909, 0.5760623196550303, 0.5877004671700454, 0.5979388127674714, 0.6052967537300402, 0.6115786358746925, 0.618534819324129, 0.6288185490414485, 0.640306571618586, 0.6524749424253163, 0.6647323318291954, 0.6764153534261167, 0.6875178444744241, 0.6985461259801593, 0.7095025759510523, 0.7203370992319149, 0.7310578691129607, 0.7416804091814464, 0.7521997524983502, 0.7626236197777839, 0.772944302462868, 0.7831436100026921, 0.7932061094368869, 0.8031519729199276, 0.8130076642796611, 0.8227701299300287, 0.8323861926327154, 0.841801804343943, 0.8509973499178773, 0.8599969535771721, 0.8688125561382792, 0.8774656615223775, 0.8859923894719786, 0.8944292134512134, 0.9027897807109537, 0.9110515518822625, 0.9191855702369571, 0.9271869795550349, 0.9350265373230724, 0.9426918350193211, 0.9501766637817987, 0.957430991797968, 0.9644314726831319, 0.971168013748481, 0.9775564375261878, 0.9836462212884314, 0.9897314410346535, 0.9972865598687561, 1.0},
	.param_9 = {0.5085638438440593, 0.3421041525729891, 0.3637376789953984},
	.param_10 = {89.31640193604967, 65.9624985898515, 56.8158200979214, 914.148794951247, 6.01028990375182, 1.04957294718297},
	.param_11 = {0.15894924643007335, 0.0719107332708376, 0.0495056277314177, 0.125650467806838, 0.00431652446476024, 0.00275995528168327},
	.param_12 = {1.4134013359193571, 1.5182789717618248, 1.5001055358504642},
	.name = {'L', 'P', '8', '0', '3', '4', '4', '8'},
};
static int64_t fg_ref_time;
static float max_charge_current;
static float term_charge_current;

static int charger_read_sensors(float *voltage, float *current, float *temp)
{
	struct sensor_value value;
	int ret;

	ret = sensor_sample_fetch(charger);
	if (ret < 0) {
		return ret;
	}

	sensor_channel_get(charger, SENSOR_CHAN_GAUGE_VOLTAGE, &value);
	*voltage = (float)value.val1 + ((float)value.val2 / 1000000);

	sensor_channel_get(charger, SENSOR_CHAN_GAUGE_TEMP, &value);
	*temp = (float)value.val1 + ((float)value.val2 / 1000000);

	sensor_channel_get(charger, SENSOR_CHAN_GAUGE_AVG_CURRENT, &value);
	*current = (float)value.val1 + ((float)value.val2 / 1000000);

	return 0;
}
#define FG_BURST_COUNT 10
#define FG_BURST_DELAY K_MSEC(100)
float fg_burst_current_accumulated = 0;
float fg_burst_delta_accumulated = 0;

static int fg_burst_index = 0;
static void fg_update_work_handler(struct k_work *work);
K_WORK_DELAYABLE_DEFINE(fg_update_work, fg_update_work_handler);

static void fg_update_work_handler(struct k_work *work)
{
	float voltage;
	float current;
	float temp;
	float state_of_charge;
	float delta;
	float time_to_empty;
	float time_to_full;
	struct sensor_module_event *sensor_module_event;
	static struct nrf_fuel_gauge_state_info fg_state;
	int ret;

	ARG_UNUSED(work);

	/* update fuel gauge state */
	ret = charger_read_sensors(&voltage, &current, &temp);
	if (ret) {
		LOG_ERR("Error: Could not read from charger device: %d", ret);
		return;
	}
	delta = (float) k_uptime_delta(&fg_ref_time) / 1000.f;
	fg_ref_time = k_uptime_get();
	state_of_charge = nrf_fuel_gauge_process(voltage, current, temp, delta, &fg_state);

	LOG_DBG("FG i:%02d", fg_burst_index);

	/* calculate TTE/TTF */
	time_to_empty = nrf_fuel_gauge_tte_get();
	time_to_full = nrf_fuel_gauge_ttf_get(-max_charge_current, -term_charge_current);
	LOG_DBG("tte: %f, ttf: %f, soc: %f, temp: %f, voltage: %f, current: %f, yhat: %f, r0: %f, t_trunc: %f", time_to_empty, time_to_full, state_of_charge, temp, voltage, current, fg_state.yhat, fg_state.r0, fg_state.T_truncated);

	fg_burst_current_accumulated += delta * current;
	fg_burst_delta_accumulated += delta;

	/* repeat measurement until we collect enough data points */
	if (fg_burst_index++ < FG_BURST_COUNT) {
		k_work_schedule(&fg_update_work, FG_BURST_DELAY);
		return;
	}

	current = fg_burst_current_accumulated / fg_burst_delta_accumulated;

	/* construct event with final data */
	sensor_module_event = new_sensor_module_event();
	__ASSERT(sensor_module_event, "Not enough heap left to allocate event");
	sensor_module_event->data.bat.timestamp = k_uptime_get();
	sensor_module_event->data.bat.mV = roundf(voltage * 1000);
	sensor_module_event->data.bat.mA = roundf(current * 1000);
	sensor_module_event->data.bat.temp = roundf(temp * 10);
	sensor_module_event->data.bat.has_current = true;
	sensor_module_event->data.bat.has_temp = true;
	sensor_module_event->data.bat.has_ttf = false;
	sensor_module_event->data.bat.has_tte = false;
	sensor_module_event->data.bat.battery_level = roundf(state_of_charge);
	if (isnormal(time_to_full)) {
		sensor_module_event->data.bat.has_ttf = true;
		sensor_module_event->data.bat.ttf = roundf(time_to_full);
	}

	if (isnormal(time_to_empty)) {
		sensor_module_event->data.bat.has_tte = true;
		sensor_module_event->data.bat.tte = roundf(time_to_empty);
	}
	sensor_module_event->type = SENSOR_EVT_FUEL_GAUGE_READY;
	APP_EVENT_SUBMIT(sensor_module_event);
}
#endif
struct sensor_msg_data {
	union {
		struct app_module_event app;
		struct data_module_event data;
		struct util_module_event util;
	} module;
};

/* Sensor module super states. */
static enum state_type {
	STATE_INIT,
	STATE_RUNNING,
	STATE_SHUTDOWN
} state;

/* Sensor module message queue. */
#define SENSOR_QUEUE_ENTRY_COUNT	10
#define SENSOR_QUEUE_BYTE_ALIGNMENT	4

K_MSGQ_DEFINE(msgq_sensor, sizeof(struct sensor_msg_data),
	      SENSOR_QUEUE_ENTRY_COUNT, SENSOR_QUEUE_BYTE_ALIGNMENT);

static struct module_data self = {
	.name = "sensor",
	.msg_q = &msgq_sensor,
	.supports_shutdown = true,
};

/* Convenience functions used in internal state handling. */
static char *state2str(enum state_type new_state)
{
	switch (new_state) {
	case STATE_INIT:
		return "STATE_INIT";
	case STATE_RUNNING:
		return "STATE_RUNNING";
	case STATE_SHUTDOWN:
		return "STATE_SHUTDOWN";
	default:
		return "Unknown";
	}
}

static void state_set(enum state_type new_state)
{
	if (new_state == state) {
		LOG_DBG("State: %s", state2str(state));
		return;
	}

	LOG_DBG("State transition %s --> %s",
		state2str(state),
		state2str(new_state));

	state = new_state;
}

/* Handlers */
static bool app_event_handler(const struct app_event_header *aeh)
{
	struct sensor_msg_data msg = {0};
	bool enqueue_msg = false;

	if (is_app_module_event(aeh)) {
		struct app_module_event *event = cast_app_module_event(aeh);

		msg.module.app = *event;
		enqueue_msg = true;
	}

	if (is_data_module_event(aeh)) {
		struct data_module_event *event = cast_data_module_event(aeh);

		msg.module.data = *event;
		enqueue_msg = true;
	}

	if (is_util_module_event(aeh)) {
		struct util_module_event *event = cast_util_module_event(aeh);

		msg.module.util = *event;
		enqueue_msg = true;
	}

	if (enqueue_msg) {
		int err = module_enqueue_msg(&self, &msg);

		if (err) {
			LOG_ERR("Message could not be enqueued");
			SEND_ERROR(sensor, SENSOR_EVT_ERROR, err);
		}
	}

	return false;
}

/* Static module functions. */

#if defined(CONFIG_EXTERNAL_SENSORS)
/* Function that enables or disables trigger callbacks from the accelerometer. */
static void accelerometer_callback_set(bool enable)
{
	int err;

	err = ext_sensors_accelerometer_trigger_callback_set(enable);
	if (err) {
		LOG_ERR("ext_sensors_accelerometer_trigger_callback_set, error: %d", err);
	}
}

static void activity_data_send(const struct ext_sensor_evt *const acc_data)
{
	struct sensor_module_event *sensor_module_event = new_sensor_module_event();

	__ASSERT(sensor_module_event, "Not enough heap left to allocate event");

	if (acc_data->type == EXT_SENSOR_EVT_ACCELEROMETER_ACT_TRIGGER)	{
		sensor_module_event->type = SENSOR_EVT_MOVEMENT_ACTIVITY_DETECTED;
	} else {
		__ASSERT_NO_MSG(acc_data->type == EXT_SENSOR_EVT_ACCELEROMETER_INACT_TRIGGER);
		sensor_module_event->type = SENSOR_EVT_MOVEMENT_INACTIVITY_DETECTED;
	}
	APP_EVENT_SUBMIT(sensor_module_event);
}

static void impact_data_send(const struct ext_sensor_evt *const evt)
{
	struct sensor_module_event *sensor_module_event = new_sensor_module_event();

	__ASSERT(sensor_module_event, "Not enough heap left to allocate event");

	sensor_module_event->data.impact.magnitude = evt->value;
	sensor_module_event->data.impact.timestamp = k_uptime_get();
	sensor_module_event->type = SENSOR_EVT_MOVEMENT_IMPACT_DETECTED;

	APP_EVENT_SUBMIT(sensor_module_event);
}

static void ext_sensor_handler(const struct ext_sensor_evt *const evt)
{
	switch (evt->type) {
	case EXT_SENSOR_EVT_ACCELEROMETER_ACT_TRIGGER:
		activity_data_send(evt);
		break;
	case EXT_SENSOR_EVT_ACCELEROMETER_INACT_TRIGGER:
		activity_data_send(evt);
		break;
	case EXT_SENSOR_EVT_ACCELEROMETER_IMPACT_TRIGGER:
		impact_data_send(evt);
		break;
	case EXT_SENSOR_EVT_ACCELEROMETER_ERROR:
		LOG_ERR("EXT_SENSOR_EVT_ACCELEROMETER_ERROR");
		break;
	case EXT_SENSOR_EVT_TEMPERATURE_ERROR:
		LOG_ERR("EXT_SENSOR_EVT_TEMPERATURE_ERROR");
		break;
	case EXT_SENSOR_EVT_HUMIDITY_ERROR:
		LOG_ERR("EXT_SENSOR_EVT_HUMIDITY_ERROR");
		break;
	case EXT_SENSOR_EVT_PRESSURE_ERROR:
		LOG_ERR("EXT_SENSOR_EVT_PRESSURE_ERROR");
		break;
	case EXT_SENSOR_EVT_AIR_QUALITY_ERROR:
		LOG_ERR("EXT_SENSOR_EVT_AIR_QUALITY_ERROR");
		break;
	default:
		break;
	}
}
#endif /* CONFIG_EXTERNAL_SENSORS */

#if defined(CONFIG_EXTERNAL_SENSORS)
static void configure_acc(const struct cloud_data_cfg *cfg)
{
		int err;
		double accelerometer_activity_threshold =
			cfg->accelerometer_activity_threshold;
		double accelerometer_inactivity_threshold =
			cfg->accelerometer_inactivity_threshold;
		double accelerometer_inactivity_timeout =
			cfg->accelerometer_inactivity_timeout;

		err = ext_sensors_accelerometer_threshold_set(accelerometer_activity_threshold,
							      true);
		if (err == -ENOTSUP) {
			LOG_WRN("The requested act threshold value not valid");
		} else if (err) {
			LOG_ERR("Failed to set act threshold, error: %d", err);
		}
		err = ext_sensors_accelerometer_threshold_set(accelerometer_inactivity_threshold,
							      false);
		if (err == -ENOTSUP) {
			LOG_WRN("The requested inact threshold value not valid");
		} else if (err) {
			LOG_ERR("Failed to set inact threshold, error: %d", err);
		}
		err = ext_sensors_inactivity_timeout_set(accelerometer_inactivity_timeout);
		if (err == -ENOTSUP) {
			LOG_WRN("The requested timeout value not valid");
		} else if (err) {
			LOG_ERR("Failed to set timeout, error: %d", err);
		}
}
#endif

static void apply_config(struct sensor_msg_data *msg)
{
#if defined(CONFIG_EXTERNAL_SENSORS)
	configure_acc(&msg->module.data.data.cfg);

	if (msg->module.data.data.cfg.active_mode) {
		accelerometer_callback_set(false);
	} else {
		accelerometer_callback_set(true);
	}
#endif /* CONFIG_EXTERNAL_SENSORS */
}

static void battery_data_get(void)
{
	struct sensor_module_event *sensor_module_event;

#if defined(CONFIG_ADP536X)
	int err;
	uint8_t percentage;
	uint16_t millivolts;

	err = adp536x_fg_soc(&percentage);
	if (err) {
		LOG_ERR("Failed to get battery level: %d", err);
		return;
	}

	err = adp536x_fg_volts(&millivolts);
	if (err) {
		LOG_ERR("Failed to get battery voltage: %d", err);
		return;
	}
	sensor_module_event = new_sensor_module_event();

	sensor_module_event->data.bat.has_current = false;
	sensor_module_event->data.bat.has_temp = false;
	sensor_module_event->data.bat.has_ttf = false;
	sensor_module_event->data.bat.has_tte = false;

	__ASSERT(sensor_module_event, "Not enough heap left to allocate event");

	sensor_module_event->data.bat.timestamp = k_uptime_get();
	sensor_module_event->data.bat.battery_level = percentage;
	sensor_module_event->data.bat.mV = millivolts;
	sensor_module_event->type = SENSOR_EVT_FUEL_GAUGE_READY;
#elif defined(CONFIG_NPM1300_CHARGER)
	fg_burst_index = 0;
	fg_burst_current_accumulated = 0;
	fg_burst_delta_accumulated = 0;
	k_work_schedule(&fg_update_work, K_NO_WAIT);
	return;
#else
	sensor_module_event = new_sensor_module_event();

	__ASSERT(sensor_module_event, "Not enough heap left to allocate event");

	sensor_module_event->type = SENSOR_EVT_FUEL_GAUGE_NOT_SUPPORTED;
#endif
	APP_EVENT_SUBMIT(sensor_module_event);
}

static void environmental_data_get(void)
{
	struct sensor_module_event *sensor_module_event;
#if defined(CONFIG_EXTERNAL_SENSORS)
	int err;
	double temperature = 0, humidity = 0, pressure = 0;
	uint16_t bsec_air_quality = UINT16_MAX;

	/* Request data from external sensors. */
	err = ext_sensors_temperature_get(&temperature);
	if (err) {
		LOG_ERR("ext_sensors_temperature_get, error: %d", err);
	}

	err = ext_sensors_humidity_get(&humidity);
	if (err) {
		LOG_ERR("ext_sensors_humidity_get, error: %d", err);
	}

	err = ext_sensors_pressure_get(&pressure);
	if (err) {
		LOG_ERR("ext_sensors_pressure_get, error: %d", err);
	}

	err = ext_sensors_air_quality_get(&bsec_air_quality);
	if (err && err == -ENOTSUP) {
		/* Air quality is not available, enable the Bosch BSEC library driver.
		 * Propagate the air quality value as -1.
		 */
	} else if (err) {
		LOG_ERR("ext_sensors_bsec_air_quality_get, error: %d", err);
	}

	sensor_module_event = new_sensor_module_event();

	__ASSERT(sensor_module_event, "Not enough heap left to allocate event");

	sensor_module_event->data.sensors.timestamp = k_uptime_get();
	sensor_module_event->data.sensors.temperature = temperature;
	sensor_module_event->data.sensors.humidity = humidity;
	sensor_module_event->data.sensors.pressure = pressure;
	sensor_module_event->data.sensors.bsec_air_quality =
					(bsec_air_quality == UINT16_MAX) ? -1 : bsec_air_quality;
	sensor_module_event->type = SENSOR_EVT_ENVIRONMENTAL_DATA_READY;
#else

	/* This event must be sent even though environmental sensors are not
	 * available on the nRF9160DK. This is because the Data module expects
	 * responses from the different modules within a certain amount of time
	 * after the APP_EVT_DATA_GET event has been emitted.
	 */
	LOG_DBG("No external sensors, submitting dummy sensor data");

	/* Set this entry to false signifying that the event carries no data.
	 * This makes sure that the entry is not stored in the circular buffer.
	 */
	sensor_module_event = new_sensor_module_event();

	__ASSERT(sensor_module_event, "Not enough heap left to allocate event");

	sensor_module_event->type = SENSOR_EVT_ENVIRONMENTAL_NOT_SUPPORTED;
#endif
	APP_EVENT_SUBMIT(sensor_module_event);
}

static int setup(void)
{
#if defined(CONFIG_EXTERNAL_SENSORS)
	int err;

	err = ext_sensors_init(ext_sensor_handler);
	if (err) {
		LOG_ERR("ext_sensors_init, error: %d", err);
		return err;
	}
#endif
#if defined(CONFIG_NPM1300_CHARGER)
	struct nrf_fuel_gauge_init_parameters parameters = { .model = &battery_model };
	struct sensor_value value;

	if (!device_is_ready(charger)) {
		LOG_ERR("Charger device not ready.");
		return -ENODEV;
	}
	err = charger_read_sensors(&parameters.v0, &parameters.i0, &parameters.t0);
	if (err < 0) {
		LOG_ERR("charger_read_sensors, error: %d", err);
		return err;
	}

	nrf_fuel_gauge_init(&parameters, NULL);
	fg_ref_time = k_uptime_get();

	err = sensor_channel_get(charger, SENSOR_CHAN_GAUGE_DESIRED_CHARGING_CURRENT, &value);
	if (err) {
		LOG_ERR("sensor_channel_get(DESIRED_CHARGING_CURRENT), error: %d", err);
		return err;
	}
	max_charge_current = (float)value.val1 + ((float)value.val2 / 1000000);
	term_charge_current = max_charge_current / 10.f;
#endif
	return 0;
}

static bool environmental_data_requested(enum app_module_data_type *data_list,
					 size_t count)
{
	for (size_t i = 0; i < count; i++) {
		if (data_list[i] == APP_DATA_ENVIRONMENTAL) {
			return true;
		}
	}

	return false;
}

static bool battery_data_requested(enum app_module_data_type *data_list,
					 size_t count)
{
	for (size_t i = 0; i < count; i++) {
		if (data_list[i] == APP_DATA_BATTERY) {
			return true;
		}
	}

	return false;
}

/* Message handler for STATE_INIT. */
static void on_state_init(struct sensor_msg_data *msg)
{
	if (IS_EVENT(msg, data, DATA_EVT_CONFIG_INIT)) {
		apply_config(msg);
		state_set(STATE_RUNNING);
	}
}

/* Message handler for STATE_RUNNING. */
static void on_state_running(struct sensor_msg_data *msg)
{
	if (IS_EVENT(msg, data, DATA_EVT_CONFIG_READY)) {
		apply_config(msg);
	}

	if (IS_EVENT(msg, app, APP_EVT_DATA_GET)) {
		if (environmental_data_requested(msg->module.app.data_list,
						 msg->module.app.count)) {
			environmental_data_get();
		}

		if (battery_data_requested(msg->module.app.data_list, msg->module.app.count)) {
			battery_data_get();
		}
	}
}

/* Message handler for all states. */
static void on_all_states(struct sensor_msg_data *msg)
{
	if (IS_EVENT(msg, util, UTIL_EVT_SHUTDOWN_REQUEST)) {
		/* The module doesn't have anything to shut down and can
		 * report back immediately.
		 */
		SEND_SHUTDOWN_ACK(sensor, SENSOR_EVT_SHUTDOWN_READY, self.id);
		state_set(STATE_SHUTDOWN);
	}
}

static void module_thread_fn(void)
{
	int err;
	struct sensor_msg_data msg = { 0 };

	self.thread_id = k_current_get();

	err = module_start(&self);
	if (err) {
		LOG_ERR("Failed starting module, error: %d", err);
		SEND_ERROR(sensor, SENSOR_EVT_ERROR, err);
	}

	state_set(STATE_INIT);

	err = setup();
	if (err) {
		LOG_ERR("setup, error: %d", err);
		SEND_ERROR(sensor, SENSOR_EVT_ERROR, err);
	}

	while (true) {
		module_get_next_msg(&self, &msg);

		switch (state) {
		case STATE_INIT:
			on_state_init(&msg);
			break;
		case STATE_RUNNING:
			on_state_running(&msg);
			break;
		case STATE_SHUTDOWN:
			/* The shutdown state has no transition. */
			break;
		default:
			LOG_ERR("Unknown state.");
			break;
		}

		on_all_states(&msg);
	}
}

K_THREAD_DEFINE(sensor_module_thread, CONFIG_SENSOR_THREAD_STACK_SIZE,
		module_thread_fn, NULL, NULL, NULL,
		K_LOWEST_APPLICATION_THREAD_PRIO, 0, 0);

APP_EVENT_LISTENER(MODULE, app_event_handler);
APP_EVENT_SUBSCRIBE(MODULE, app_module_event);
APP_EVENT_SUBSCRIBE(MODULE, data_module_event);
APP_EVENT_SUBSCRIBE(MODULE, util_module_event);
